var URL="https://vending.jianlangcn.com/machine/";$(function(){FastClick.attach(document.body)});var common={deleteCoup:function(e){$.ajax({type:"get",url:URL+"jl/coup/del?pks="+e,success:function(e){console.log(e),200==e.status&&location.reload()}})},vmCoupon:function(a){$.ajax({type:"post",url:URL+"pay/weixin/vmCoupon",dataType:"json",data:a,success:function(e){if(200==e.status){if(t=e.data.payFee){var s=a.totalFee-t;s*=.01,$("#price3").html(s.toFixed(2))}else t=.01*a.totalFee,$(".yh2").html("无可用优惠券"),$(".price2").hide();$("#price1").html(t.toFixed(2)),sessionStorage.setItem("coupSn",e.data.coupSn)}else if(400==e.status){var t;if(t=e.data.payFee){s=a.totalFee-t;s*=.01,$("#price3").html(s.toFixed(2))}else t=.01*a.totalFee,$(".yh2").html("无可用优惠券"),$(".price2").hide();$("#price1").html(t.toFixed(2)),sessionStorage.setItem("coupSn",e.data.coupSn)}}})},createOrder:function(e){$.ajax({type:"post",url:URL+"pay/weixin/createOrder",dataType:"json",data:e,success:function(e){if(console.log(e),200==e.status){var s=e.data;WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:s.appId,timeStamp:s.timeStamp,nonceStr:s.nonceStr,package:s.packageValue,signType:s.signType,paySign:s.paySign},function(e){console.log(e),"get_brand_wcpay_request:ok"==e.err_msg&&(window.location.href="https://vending.jianlangcn.com/admin/view/dist/coupon.html")})}}})},couponInfo:function(e){$.ajax({type:"get",url:URL+"jl/coup/wxinfo/"+e,dataType:"json",async:!1,success:function(e){200==e.status&&($("#dateLimit").html(e.data.dateLimit),$("#dateLimit2").html(e.data.dateLimit),$("#coupSn").html(e.data.coupSn),$.ajax({type:"get",url:URL+"jl/dr/wxinfo/"+e.data.jlDrPk,async:!1,dataType:"json",success:function(e){$("#jlHospNm").html(e.data.jlHospNm),$("#jlHospNm2").html(e.data.jlHospNm);var s={w:[{k:"jlHospPk",v:e.data.jlHospPk,m:"LK"}],o:[],p:{n:1,s:10}};s=JSON.stringify(s),s=encodeURI(s),200==e.status&&$.ajax({type:"get",url:URL+"jl/vm/wxlist?query="+s,async:!1,dataType:"json",success:function(e){for(var s=e.data.items,t="",a=0;a<s.length;a++){0==a?t=t+""+s[a].addrDet:s[a].addrDet;var i='<div class="list flex-box"><div class="list-left"><div class="circle"></div></div><div class="list-right flex1"><div class="number flex-box"><p class="number-left">NO：'+s[a].vmSn+'</p><p class="number-right">'+s[a].depNm+'</p></div><p class="texts">'+s[a].addrDet+"</p></div></div>";$("#coupList").append(i)}$("#addrDet").html(t)}})}}))}})},wxedit:function(e){e=JSON.stringify(e),$.ajax({type:"post",data:e,dataType:"json",url:URL+"jl/fb/wxedit",contentType:"application/json",success:function(e){console.log(e),200==e.status&&($.toast("提交成功"),sessionStorage.removeItem("info"),setTimeout(function(){location.reload()},500))}})},coupList:function(e){var c='<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无数据</span></div>';$(".content").html('<div class="weui-loadmore"><i class="weui-loading"></i><span class="weui-loadmore__tips">正在加载</span></div>'),$.ajax({type:"get",url:URL+"jl/coup/wxcoupList?jlCsrPk="+e,dataType:"json",success:function(e){if(console.log(e),200==e.status){var s=e.data;if(0<s.length){var t,a,i,o;$(".content").html("");for(var n=0;n<s.length;n++){t=s[n].jlDrVo?s[n].jlDrVo.jlHospNm:"没有",s[n].jlCoupVo?(a=s[n].jlCoupVo.dateLimit,i=s[n].jlCoupVo.coupSn,o=s[n].jlCoupVo.jlCoupPk):o=i=a="没有";var l='<div class="weui-flex section align-center" data-pk="'+o+'"><div class="borders"></div><div class="main"><p class="name">'+t+'</p><p class="time">有效期至:'+a+'</p><p class="number">NO:'+i+'</p></div><div class="remove">删除</div></div>';$(".content").append(l)}}else $(".content").html(c)}else $(".content").html(c)}})},hosplist:function(e){var s="";s=e?URL+"jl/hosp/wxlist?query="+e:URL+"jl/hosp/wxlist";var i='<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无数据</span></div>';$.ajax({type:"get",url:s,dataType:"json",success:function(e){if(console.log(e),200==e.status){$("#lists").html("");var s=e.data.items;if(s)for(var t=0;t<s.length;t++){var a='<div class="list" data-id="'+s[t].jlHospPk+'"><p class="list-title">'+s[t].hospNm+"</p></div>";$("#lists").append(a)}else $("#lists").html(i)}else $("#lists").html(i)}})},scan:function(){$.ajax({url:URL+"/weixin/sign/jssign?url=https://vending.jianlangcn.com/admin/view/dist/scan.html",type:"get",dataType:"json",success:function(e){console.log(e),wx.config({debug:!1,appId:"wxfad716c770341d1d",timestamp:e.timestamp,nonceStr:e.nonceStr,signature:e.signature,jsApiList:["checkJsApi","scanQRCode"]}),wx.error(function(e){}),wx.ready(function(){wx.checkJsApi({jsApiList:["scanQRCode"],success:function(e){}}),wx.scanQRCode({needResult:0,scanType:["qrCode","barCode"],success:function(e){console.log(e)}})})}})},vmList2:function(e){},vmList:function(e){var s="";s=e?URL+"jl/vm/wxlist?query="+e:URL+"jl/vm/wxlist";var i='<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无数据</span></div>';$.ajax({type:"get",url:s,dataType:"json",success:function(e){if(console.log(e),200==e.status){$("#lists").html("");var s=e.data.items;if(s)for(var t=0;t<s.length;t++){var a='<div class="list"  data-id="'+s[t].jlVmPk+'"><div class="weui-flex"><div class="weui-flex__item initial-flex name" style="margin-right:30px">'+s[t].depNm+'</div><div class="weui-flex__item number">NO：'+s[t].jlVmPk+'</div></div><div class="desc">'+s[t].addrDet+"</div></div>";$("#lists").append(a)}else $("#lists").html(i)}else $("#lists").html(i)}})},hospitalDetail:function(e){$.ajax({type:"get",url:URL+"jl/hosp/wxinfo/"+e,dataType:"json",success:function(e){if(console.log(e),200==e.status)for(var s=e.data,t=0;t<s.length;t++){var a='<div class="list2" data-id="1"><div class="weui-flex"><div class="weui-flex__item initial-flex name">'+s[t].impDep+'</div><div class="weui-flex__item number">NO：'+s[t].depNo+'</div></div><div class="desc">'+s[t].info+"</div></div>";$("#lists").append(a)}},error:function(e){console.log(e)}})},edit:function(e,t){var s=sessionStorage.getItem("params");s=JSON.parse(s),t=$.extend(s,t),t=JSON.stringify(t),$.ajax({type:"post",url:e+"jl/csr/wxedit",data:t,dataType:"json",contentType:"application/json",success:function(e){if(console.log(e),200==e.status){$.toast("修改成功");var s=sessionStorage.getItem("userInfo");s=JSON.parse(s),t=JSON.parse(t),s=$.extend(s,t),s=JSON.stringify(s),t=JSON.stringify(t),sessionStorage.setItem("userInfo",s),sessionStorage.setItem("params",t),sessionStorage.removeItem("hasLogin"),sessionStorage.removeItem("openid"),setTimeout(function(){window.location.href="person-info.html"},600)}}})},getOpenid:function(e){if(sessionStorage.getItem("openid"));else{var s=encodeURI(e);sessionStorage.getItem("hasLogin")||(sessionStorage.setItem("hasLogin",!0),window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxfad716c770341d1d&redirect_uri="+s+"&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect")}},getCode:function(i){var e=sessionStorage.getItem("openid"),o=this;if(e){var s=sessionStorage.getItem("userInfo");s=JSON.parse(s),o.showData(s)}else{var t=window.location.href.split("code=")[1].split("&")[0];sessionStorage.setItem("code",t),$.ajax({type:"get",url:URL+"weixin/access/login",data:{code:t},dataType:"json",success:function(e){if(console.log(e),200==e.status){var s=e.data.wxuser,t=e.data.userinfo;s=$.extend(s,t),console.log(s),sessionStorage.setItem("openid",s.openId);var a={};a.openid=s.openId,(a=$.extend(a,t)).nkNm=s.nickname,a.head_url=s.headImgUrl,a.sex=s.sexDesc,a=JSON.stringify(a),sessionStorage.setItem("params",a),sessionStorage.setItem("jlCsrPk",s.jlCsrPk),o.showData(s),s=JSON.stringify(s),sessionStorage.setItem("userInfo",s),sessionStorage.setItem("token",e.data.token),i&&i()}else 400==e.status&&(sessionStorage.removeItem("hasLogin"),location.reload())}})}},addCookie:function(e,s,t){var a=e+"="+escape(s);if(a+="; path=/",t&&0<t){var i=new Date,o=3600*t*1e3;i.setTime(i.getTime()+o),a+="; expires="+i.toGMTString()}document.cookie=a},set:function(e,s,t){var a=new Date,i=t;a.setTime(a.getTime()+24*i*3600*1e3),document.cookie=e+"="+s+";expires="+a.toGMTString()+"; path=/"},showData:function(e){$("#headImgUrl").attr("src",e.headImgUrl),$("#nickname").html(e.nickname),$("#picker").html(e.sexDesc),e.name&&$("#username").html(e.name),e.phone&&$("#phone").html(e.phone),(e.age||0==e.age)&&$("#picker2").html(e.age),e.addr&&$("#addr").html(e.addr)}};